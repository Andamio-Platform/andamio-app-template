# Session Archive: January 12-18, 2026

> Sessions 5-20 covering Pioneers launch, V2 Gateway migration, transaction system migration, and contributor flow testing.

---

## January 18, 2026 (Session 20) - Auth Response Fix + Teacher/Manager API Response Handling

**Auth Response Fix** (`src/lib/andamio-auth.ts`):
- Gateway `/api/v2/auth/login/validate` response structure didn't match expectations
- **Old expectation**: `{ token, user: { stake_address, access_token_alias } }`
- **Actual response**: `{ jwt, user: { id, cardano_bech32_addr, access_token_alias } }`
- Updated `ValidateSignatureApiResponse` interface and extraction logic

**Teacher/Manager API Response Handling**:
- Gateway merged endpoints return `content` nested object, not flat fields
- **API returns**: `{ content: { title, code, live } }`
- **UI expected**: `{ title, course_code }`
- Added content flattening in hooks: `useTeacherCourses`, `useManagerProjects`
- Updated `source` value from `"on-chain-only"` to `"chain_only"` across 4 files

**Files Modified**:
- `src/lib/andamio-auth.ts` - Fixed response parsing
- `src/hooks/api/use-teacher-courses.ts` - Added content flattening + debug logging
- `src/hooks/api/use-manager-projects.ts` - Added content flattening + debug logging
- `src/hooks/api/use-contributor-projects.ts` - Fixed source value in type comment
- `src/app/(studio)/studio/course/page.tsx` - Fixed source comparison
- `src/app/(app)/studio/project/page.tsx` - Fixed source comparison

---

## January 18, 2026 (Session 19) - V2 Transaction Migration Finalization + V1 Deprecation

**Components Migrated to V2**:
| Component | TX Type | Change |
|-----------|---------|--------|
| `BurnModuleTokens` | `COURSE_TEACHER_MODULES_MANAGE` | Changed to `useSimpleTransaction` + `useTxWatcher` |
| `ProjectCredentialClaim` | `PROJECT_CONTRIBUTOR_CREDENTIAL_CLAIM` | Changed to `useSimpleTransaction` + `useTxWatcher` |
| `CreateCourseDialog` | `INSTANCE_COURSE_CREATE` | Changed to `useSimpleTransaction` |

**Key Clarification**: `BurnModuleTokens` uses the unified `/api/v2/tx/course/teacher/modules/manage` endpoint - there is no separate burn endpoint.

**Deprecation Notices Added**:
| Component/Hook | Status | Replacement |
|----------------|--------|-------------|
| `useAndamioTransaction` | `@deprecated` | `useSimpleTransaction` + `useTxWatcher` |
| `AndamioTransaction` | `@deprecated` | Specific TX components (e.g., `TaskCommit`, `EnrollInCourse`) |
| `PendingTxIndicator` | `@deprecated` | Individual component TX tracking via `useTxWatcher` |

**Hash Utilities Migrated** (January 19, 2026):
- Moved from `@andamio/transactions` to `~/lib/utils/`:
  - `computeSltHashDefinite` → `~/lib/utils/slt-hash.ts`
  - `computeAssignmentInfoHash` → `~/lib/utils/assignment-info-hash.ts`
  - `computeTaskHash` → `~/lib/utils/task-hash.ts`
- Removed `blakejs` and `cbor` dependencies from `@andamio/transactions`

---

## January 18, 2026 (Session 18) - V2 Transaction System Migration Complete

Migrated all 16 remaining transaction components from V1 (`useAndamioTransaction` + client-side Koios polling) to V2 (`useSimpleTransaction` + `useTxWatcher` + gateway auto-confirmation).

**Components Migrated**:
- `mint-module-tokens.tsx` - COURSE_TEACHER_MODULES_MANAGE
- `enroll-in-course.tsx` - COURSE_STUDENT_ASSIGNMENT_COMMIT
- `assignment-update.tsx` - COURSE_STUDENT_ASSIGNMENT_UPDATE/COMMIT
- `task-commit.tsx` - PROJECT_CONTRIBUTOR_TASK_COMMIT
- `task-action.tsx` - PROJECT_CONTRIBUTOR_TASK_ACTION
- `tasks-manage.tsx` - PROJECT_MANAGER_TASKS_MANAGE
- `tasks-assess.tsx` - PROJECT_MANAGER_TASKS_ASSESS

**Schema Updates** (`~/config/transaction-schemas.ts`):
- Added optional side effect params to all Zod schemas
- Params like `module_code`, `network_evidence`, `task_hash`, `evidence` now properly typed

---

## January 18, 2026 (Session 17) - V2 API Migration Fixes - Import Errors Resolved

Fixed remaining TypeScript errors after the V2 Gateway API migration.

**Files Modified**:
1. `src/components/instructor/pending-reviews-list.tsx`
   - Changed `usePendingAssessments` → `useTeacherCommitments` hook
   - Removed `accessTokenAlias` prop
   - Updated type from `OrchestrationTeacherAssignmentCommitmentItem` → `TeacherAssignmentCommitment`

2. `src/app/(app)/studio/project/[projectid]/commitments/page.tsx`
   - Rewrote to use `useManagerCommitments` and `useProject` hooks
   - Fixed `project.states?.[0]?.project_state_policy_id` → `project.contributor_state_id`

3. `src/components/transactions/course-prereqs-selector.tsx`
   - Changed `useTeachableCoursesWithDetails` → `useTeacherCoursesWithModules` hook

**New Hooks Added**:
- `useManagerCommitments(projectId?)` - Fetch pending task commitments for managers
- `useTeacherCoursesWithModules()` - Fetch teacher courses with module details for prereq selection

---

## January 18, 2026 (Session 16) - Full V2 Gateway API Migration

**Files Changed** (~160 files):
- Infrastructure: New gateway proxy, client, types
- Hooks: Migrated all API hooks to gateway endpoints
- Components: Updated all transaction and data-fetching components
- Pages: Updated all route pages to use new API paths
- Providers: Added new auth and pending-tx provider components

**Key Changes**:
1. **Single Gateway Proxy** - All API calls now route through `/api/gateway/[...path]`
2. **Generated Types** - Types now generated from `doc.json` OpenAPI spec via `npm run generate:types`
3. **Role Naming** - Fixed "admin" → "owner" role naming in project TX endpoints
4. **Merged Endpoints** - Frontend now uses merged endpoints that combine DB + on-chain data
5. **Removed Legacy Code** - Deleted old Andamioscan hooks, separate proxy routes

**New Files Created**:
- `src/lib/gateway.ts` - Gateway client functions
- `src/lib/andamio-gateway.ts` - Merged endpoint helpers
- `src/types/generated/gateway.ts` - Auto-generated types (1672+ lines)
- `src/types/generated/index.ts` - Strict type re-exports (301 lines)
- New role-based hooks: `use-contributor-projects.ts`, `use-manager-projects.ts`, `use-project.ts`, `use-student-courses.ts`, `use-teacher-courses.ts`

---

## January 16, 2026 (Session 15) - Andamioscan Issue #11 Resolved

**Resolved**: Andamioscan issue #11 - `task_id` now populated

The blocker preventing reliable task matching in pending assessments and submissions was fixed upstream. This unblocks:
- Assessment sync functionality
- Reliable task matching (no more lovelace/content fallback needed)
- Full contributor flow testing

---

## January 15, 2026 (Session 11) - Manager Assess Transaction Fixes

**Problem 1**: Transaction API returned 400 Bad Request with "key 'alias' not found"
- **Root Cause**: `task_decisions` array was sending `{ task_hash, outcome }` instead of `{ alias, outcome }`
- **Fix**: Updated `tasks-assess.tsx` line 119 to use `alias: contributorAlias`

**Problem 2**: DB API side effect returned 400 Bad Request
- **Root Cause**: DB API expects uppercase decision values (`ACCEPTED`, `REFUSED`, `DENIED`) but code was sending lowercase
- **Fix**: Updated transaction definition schema to use uppercase enum values, added `outcomeToDbDecision` mapping

**Task Matching for Pending Assessments**:
Implemented fallback matching when `task_id` is empty:
```typescript
const findMatchingTask = (assessment) => {
  if (assessment.task_id) return taskMap.get(assessment.task_id);
  if (assessment.task_lovelace > 0) return taskByLovelace.get(assessment.task_lovelace);
  if (assessment.task_content) return taskByContent.get(assessment.task_content);
  return undefined;
};
```

---

## January 15, 2026 (Session 10) - Contributor Commitment Sync & API Field Fixes

**Andamioscan API Field Name Fixes** (`src/lib/andamioscan.ts`):
| Expected Field | Actual API Field |
|---------------|------------------|
| `pending_submissions` | `tasks_submitted` |
| `completed_tasks` | `tasks_accepted` |
| `credentials` | `claimed_credentials` |

**Contributor Sync UI Implementation**:
Added sync UI to contributor page that:
- Shows on-chain submission when DB record is missing
- Matches submission to DB task by `task_hash` or `lovelace`
- Provides sync button to create DB commitment from on-chain data

**Manager Task Sync** (Separation of Concerns):
- Task hash sync requires manager permissions (403 for contributors)
- Now shows warning in Project Studio when tasks need hash sync
- Contributors only sync their own commitments

---

## January 14, 2026 (Session 9) - Contributor Transaction Model & Commitment Sync

**Documentation Created**: `CONTRIBUTOR-TRANSACTION-MODEL.md` - Complete documentation of 3-transaction contributor lifecycle (COMMIT, ACTION, CLAIM)

**New Features Implemented**:
| Feature | Files | Description |
|---------|-------|-------------|
| **Commitments Page** | `src/app/(app)/studio/project/[projectid]/commitments/page.tsx` | Manager view for pending task assessments |
| **Commitment Sync Utility** | `src/lib/project-commitment-sync.ts` | Sync on-chain submissions to DB commitment records |
| **Project Eligibility** | `src/lib/project-eligibility.ts` | Check contributor eligibility for tasks |

**Commitment Sync Flow**:
1. Manager views pending assessments from Andamioscan
2. "DB Status" column shows ✅ (exists) or ⚠️ "Missing"
3. Click "Sync" button to create DB record from on-chain data
4. Calls: `create` → `submit` → `confirm-tx` endpoints

---

## January 14, 2026 (Session 8) - Project V2 API Integration Testing

**API Endpoints Requested & Deployed**:
| Endpoint | Version | Purpose |
|----------|---------|---------|
| `POST /project-v2/owner/project/register` | v1.3.1 | Register on-chain project to DB with title |
| `GET /project-v2/manager/tasks/{policy_id}` | v1.3.3 | List all tasks including DRAFT status |

**Project V2 Testing Status**:
| Feature | Status | Notes |
|---------|--------|-------|
| Project Register | ✅ Working | Owner can register on-chain project with title |
| Managers Sync | ✅ Working | Syncs on-chain managers to DB |
| Task Create | ✅ Working | Manager can create draft tasks |
| Task List | ✅ Working | Shows all tasks including drafts |
| Task Update | ❌ Blocked | API returns 404 "Task not found" |
| Task Delete | ❌ Blocked | API returns 404 "Task not found" |

---

## January 14, 2026 (Session 7) - Transaction Schema Audit + Design System

**Atlas TX API Schema Audit**: Audited all 16 transaction definitions against swagger.json.

| Status | Count | Notes |
|--------|-------|-------|
| ✅ Match | 12 | All course txs, most project txs |
| ⚠️ Minor | 4 | Missing optional `initiator_data` (acceptable) |
| ❌ Critical | 0 | All critical issues resolved |

**Design System Compliance**: Fixed hardcoded colors:
- `error.tsx`: `text-red-600` → `text-destructive`
- `pending-tx-popover.tsx`: `bg-yellow-500` → `bg-warning`

---

## January 14, 2026 (Session 6) - Public Course Credential Claim

**Build Fixes**: Fixed ESLint errors: missing `useRouter` import in dashboard, unused variables in multiple files.

**Public Course Credential Claim**: Added `CredentialClaim` component to `UserCourseStatus` on public course page.

**Credential Claim States**:
| Condition | UI Shown |
|-----------|----------|
| 100% complete + no credential | "Course Complete!" celebration + CredentialClaim |
| <100% + some completions + no pending | Understated claim link |
| Has pending assignment | "Pending Assessment" info |
| No completions yet | "You're enrolled!" message |

---

## January 13, 2026 (Session 5) - Credential Claim + Dashboard Cleanup

**CredentialClaim Integration**: Added `CredentialClaim` component to `AssignmentCommitment` when `networkStatus === "ASSIGNMENT_ACCEPTED"`.

**Sync-from-Chain Feature**: When student has on-chain commitment but no DB record, they can now enter evidence and sync to database.

**Dashboard Cleanup**: Removed `CreateCourse` and `CreateProject` from dashboard. Changed grid from 4-col to 2-col.

---

## January 13, 2026 - Tx Loop 2 Complete

**Assignment Commitment API Fix**: Fixed student view to use correct API field names: `network_evidence`, `network_status`, `network_evidence_hash`.

**Instructor Dashboard Overhaul**: Fixed endpoint path, request body, and added detailed commitment fetching.

**API Field Naming Pattern**:
```
network_evidence      → Tiptap JSON content
network_status        → "PENDING_APPROVAL", "ASSIGNMENT_ACCEPTED", etc.
network_evidence_hash → 64-char hex hash
pending_tx_hash       → Transaction hash while pending
```

**GitHub Issues Created**: #33, #34, #35

---

## January 13, 2026 - Loop 3 Testing

**CourseTeachersCard Component**: New card for Studio course pages showing on-chain vs database teachers with sync capability.

**Loop 3 Testing Status**:
- [x] On-chain teachers visible via Andamioscan API
- [x] Database teachers visible after sync
- [x] Sync status comparison working ("In Sync" badge)
- [ ] Module minting data flow — blocked by Andamioscan issue

---

## January 12, 2026 - Rollout Day

**Context**: V2 Preprod Rollout day. Andamio Pioneers launches Wednesday January 14.

**Completed**:
| Task | Details |
|------|---------|
| **Access Token Minting UX** | New onboarding shows "Confirming on-chain" while tx pending. Smart refresh via `refreshAuth()` instead of full page reload. |
| **API Method Standardization** | Fixed all PATCH/PUT/DELETE → POST. Go API uses only GET (reads) and POST (writes). |
| **DB API Auth Fix** | Resolved "Failed to create user" error (API-side fix deployed). |
| **Documentation Sync** | Updated CHANGELOG, PENDING-TX-WATCHER.md, SIDE-EFFECTS-INTEGRATION.md |

**Deferred (Post-Pioneers)**:
- Assignment System Hooks (12 endpoints)
- Remaining DB API hooks (38 endpoints at 56% coverage)
- Project System routes (7 remaining routes)
