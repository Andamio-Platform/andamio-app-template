# Session Archive: January 19-25, 2026

> Sessions 21-28 covering TX Watcher confirmation fixes, Gateway taxonomy compliance, and L1 Core package implementation.

---

## January 21, 2026 (Session 28) - TX Watcher & Confirmation Fixes

**Problem**: Transaction components stuck on "Confirming on blockchain..." even after TX confirmed on-chain.

**Root Cause Analysis**:
1. `useTxWatcher` only treated `["updated", "failed", "expired"]` as terminal states
2. Gateway TX state machine flow: `pending` → `confirmed` → `updated`
3. Gateway slow to transition from `confirmed` to `updated` (background DB processing)
4. `onComplete` callbacks only checked for `status.state === "updated"`
5. Result: UI stuck waiting for `"updated"` that might take 30+ seconds after on-chain confirmation

**Fixes Applied**:

| Fix | Description |
|-----|-------------|
| Add "confirmed" to terminal states | `use-tx-watcher.ts` - Stop polling when TX confirmed on-chain |
| Update `isSuccess` check | Return `true` for both `"confirmed"` and `"updated"` |
| Fix stale closure in CreateCourseDialog | Use refs for metadata to avoid closure capture issues |
| Stabilize polling effect | Use refs for callbacks to prevent effect restarts |
| Increase poll interval | 10s → 15s (closer to Cardano block time) |

**Files Updated (21 total)**:

*Core hooks*:
- `src/hooks/use-tx-watcher.ts` - Terminal states, polling stability

*Transaction components (17)*:
- `src/components/transactions/*.tsx` - All `onComplete` callbacks updated to check `"confirmed" || "updated"`
- `src/components/learner/assignment-commitment.tsx` (2 occurrences)
- `src/components/courses/create-course-dialog.tsx` - Complete rewrite with no-redirect pattern

*Other*:
- `src/app/(app)/course/[coursenft]/[modulecode]/page.tsx` - Removed unused `useLessons` hook
- `src/hooks/api/use-slt.ts` - Fixed unused `moduleIndex` param

**New Pattern for Transaction Components**:
```typescript
const { status: txStatus, isSuccess: txConfirmed } = useTxWatcher(
  result?.requiresDBUpdate ? result.txHash : null,
  {
    onComplete: (status) => {
      // Check for BOTH states - confirmed means on-chain, updated means DB done
      if (status.state === "confirmed" || status.state === "updated") {
        // Handle success
        toast.success("Transaction Complete!");
        void onSuccess?.();
      } else if (status.state === "failed" || status.state === "expired") {
        toast.error("Transaction Failed");
      }
    },
  }
);
```

**CreateCourseDialog UX Improvement**:
- Before: Provisioning overlay → redirect via `window.location.href` → wallet disconnects
- After: Watch TX in drawer → invalidate cache → close drawer → course appears in list → toast with "Open Course" action
- No page reload, wallet stays connected

---

## January 21, 2026 (Session 27) - Gateway Taxonomy Compliance

**NullableString Type Errors - FIXED**

The OpenAPI spec generates `NullableString` as `object` type. Rather than waiting for API team fixes, we implemented client-side handling:

1. **Created `src/lib/type-helpers.ts`** with `getString()` and `getOptionalString()` utilities
2. **Fixed 41 files** with proper type checking patterns
3. **Extended `LessonResponse`** type in `src/types/generated/index.ts` to include `slt_index`

**Field Renames Applied**:
| Old Field | New Field | Type |
|-----------|-----------|------|
| `status` | `module_status` / `task_status` / `commitment_status` | Various |
| `module_code` | `course_module_code` | CourseModuleV2 |
| `module_index` | `index` | SltV2 |
| `module_hash` | `slt_hash` | CourseModuleV2 |
| `course_nft_policy_id` | `course_id` | Various |
| `lovelace` | `lovelace_amount` | Task types |

**NullableString Pattern**:
```typescript
// API generates NullableString as `object` type, cast to unknown first
const rawTitle = task.title as unknown;
const title = typeof rawTitle === "string" ? rawTitle : "";

// Or use the helper function
import { getString } from "~/lib/type-helpers";
const title = getString(task.title);
```

---

## January 21, 2026 (Session 26) - L1 Core Package Implementation

**L1 Core Package Implementation - COMPLETE**

Created `@andamio/core` package at `packages/core/`:

**Package Structure**:
```
packages/core/
├── src/
│   ├── utils/
│   │   └── hashing/
│   │       ├── slt-hash.ts          # Module token name computation
│   │       ├── task-hash.ts         # Task hash computation
│   │       ├── commitment-hash.ts   # Evidence hash (renamed from assignment-info-hash)
│   │       └── index.ts
│   ├── constants/
│   │   ├── cardano.ts               # Explorer URLs, networks
│   │   ├── policies.ts              # Policy IDs, asset name helpers
│   │   └── index.ts
│   └── index.ts
├── package.json
├── tsconfig.json
└── tsup.config.ts
```

**Package Exports**:
```typescript
// Hashing utilities
import { computeSltHash, computeTaskHash, computeCommitmentHash } from "@andamio/core/hashing";

// Constants
import { getTxExplorerUrl, isValidPolicyId, CardanoNetwork } from "@andamio/core/constants";
```

**Codebase Updates**:
- Updated 11 source files to import from `@andamio/core/hashing`
- Old utility files in `src/lib/utils/` now re-export from `@andamio/core` for backwards compatibility
- Fixed stale `PendingTxIndicator` → `PendingTxPopover` import in `auth-status-bar.tsx`
- Package builds successfully (ESM, CJS, TypeScript declarations)

---

## January 21, 2026 (Session 25) - API Taxonomy Audit + Type Regeneration

**API Taxonomy Audit + Type Regeneration**:
- Audited gateway API spec against `api-taxonomy` skill
- Identified 6 taxonomy violations, wrote REPL note to API team
- API team deployed fixes:
  - `admin_alias` → `owner_alias` (Project)
  - `status` → `project_status`, `task_status`, `commitment_status`
  - `lovelace` → `lovelace_amount`
  - `evidence_hash` → `assignment_evidence_hash`, `task_evidence_hash`
  - `assessment_decision` → `task_outcome`
  - New endpoint: `POST /v2/course/owner/teachers/update`
- Regenerated types from updated spec (`npm run generate:types`)
- Created `src/types/generated/index.ts` with type aliases
- Fixed `admin_alias` → `owner_alias` in `studio/project/[projectid]/page.tsx`

**Blocked by**:
- OpenAPI spec types `NullableString` as `object` (should be `string | null`)
- 339 type errors until API team fixes the spec

---

## January 21, 2026 (Session 24) - Cleanup and Renaming

**Completed**:
- Deleted 6 deprecated/unused files
- Renamed `use-simple-transaction.ts` → `use-transaction.ts`
- Renamed `useSimpleTransaction()` → `useTransaction()`
- Updated 21 import references
- Aligned proposal with API taxonomy rules

**Files Deleted**:
| File | Size | Reason |
|------|------|--------|
| `src/lib/andamio-gateway.ts` | 14KB | Replaced by `gateway.ts` |
| `src/hooks/use-andamio-fetch.ts` | 9KB | Replaced by React Query hooks |
| `src/hooks/use-andamio-transaction.ts` | 16KB | V1 pattern, replaced by V2 |
| `src/hooks/use-transaction.ts` (old) | 200 lines | Unused older version |
| `src/components/layout/pending-tx-indicator.tsx` | 2KB | Replaced by `pending-tx-popover.tsx` |
| `src/components/transactions/andamio-transaction.tsx` | 5KB | V1 component, replaced by specific TX components |

---

## Layered Architecture Implementation Status

**Status**: Phase 1 - L1 Core Complete, Ready for L2/L3

Implementing the layered architecture proposal (`layered-proposal-review.md`).

**Build Order** (from proposal):
```
L1 (Core)         ─┐
L2 (Integration)  ─┼─ concurrent → LAUNCH
L3 (Components)   ─┤
L5 (App)          ─┘       ↓
                    L4 (Features) - post-launch extraction
```

**Next Steps** (L2 Integration):
1. [ ] Reorganize hooks into `course/` and `project/` subdirectories
2. [ ] Remove deprecated `andamioscan.ts` (1497 lines)
3. [ ] Clean up remaining V1 patterns
